<%init>
use lib '/var/www/html/lib';
use AppLib qw(get_user_by_session dbh format_date_ro);
use CGI qw(cookie param);

my $q = CGI->new;
my $session_cookie = $q->cookie('SESSION') || '';
my $user = get_user_by_session($session_cookie);

# Filter parameters
my $search = $q->param('search') || '';
my $judet = $q->param('judet') || '';
my $domeniu = $q->param('domeniu') || '';
my $subdomeniu = $q->param('subdomeniu') || '';
my $dimensiune = $q->param('dimensiune') || '';
my $stadiu = $q->param('stadiu') || '';
my $sector = $q->param('sector') || '';
my $sort = $q->param('sort') || 'created_at_desc';

my @santiere = ();
my $total_count = 0;

# Database query
my $dbh = dbh();
eval {
    my @conditions;
    my @params;
    
    if ($search) {
        push @conditions, "(titlu LIKE ? OR descriere LIKE ? OR solicitari LIKE ?)";
        push @params, "%$search%", "%$search%", "%$search%";
    }
    if ($judet) {
        push @conditions, "judet = ?";
        push @params, $judet;
    }
    if ($domeniu) {
        push @conditions, "domeniu = ?";
        push @params, $domeniu;
    }
    if ($subdomeniu) {
        push @conditions, "subdomeniu = ?";
        push @params, $subdomeniu;
    }
    if ($dimensiune) {
        push @conditions, "dimensiune = ?";
        push @params, $dimensiune;
    }
    if ($stadiu) {
        push @conditions, "stadiu = ?";
        push @params, $stadiu;
    }
    if ($sector) {
        push @conditions, "sector = ?";
        push @params, $sector;
    }
    
    my $where_clause = @conditions ? "WHERE " . join(' AND ', @conditions) : '';
    
    # Get total count
    my $count_sql = "SELECT COUNT(*) FROM santiere $where_clause";
    my $count_sth = $dbh->prepare($count_sql);
    $count_sth->execute(@params);
    ($total_count) = $count_sth->fetchrow_array;
    
    # Get results with sorting
    my %sort_map = (
        'created_at_desc' => 'created_at DESC',
        'created_at_asc' => 'created_at ASC',
        'valoare_desc' => 'valoare DESC',
        'valoare_asc' => 'valoare ASC',
        'titlu_asc' => 'titlu ASC',
        'titlu_desc' => 'titlu DESC'
    );
    my $order_by = $sort_map{$sort} || 'created_at DESC';
    my $sql = "SELECT * FROM santiere $where_clause ORDER BY $order_by LIMIT 50";
    my $sth = $dbh->prepare($sql);
    $sth->execute(@params);
    while (my $row = $sth->fetchrow_hashref) {
        push @santiere, $row;
    }
};

# Get unique values for filters
my $judete = $dbh->selectcol_arrayref("SELECT DISTINCT judet FROM santiere WHERE judet IS NOT NULL ORDER BY judet");
my $domenii = $dbh->selectcol_arrayref("SELECT DISTINCT domeniu FROM santiere WHERE domeniu IS NOT NULL ORDER BY domeniu");
my $subdomenii = $dbh->selectcol_arrayref("SELECT DISTINCT subdomeniu FROM santiere WHERE subdomeniu IS NOT NULL ORDER BY subdomeniu");
my $stadii = $dbh->selectcol_arrayref("SELECT DISTINCT stadiu FROM santiere WHERE stadiu IS NOT NULL ORDER BY stadiu");

# Build URLs for removing filters
my $url_remove_search = "?";
$url_remove_search .= "judet=$judet&" if $judet;
$url_remove_search .= "domeniu=$domeniu&" if $domeniu;
$url_remove_search .= "subdomeniu=$subdomeniu&" if $subdomeniu;
$url_remove_search .= "dimensiune=$dimensiune&" if $dimensiune;
$url_remove_search .= "stadiu=$stadiu&" if $stadiu;
$url_remove_search .= "sector=$sector&" if $sector;
$url_remove_search .= "sort=$sort";

my $url_remove_judet = "?";
$url_remove_judet .= "search=$search&" if $search;
$url_remove_judet .= "domeniu=$domeniu&" if $domeniu;
$url_remove_judet .= "subdomeniu=$subdomeniu&" if $subdomeniu;
$url_remove_judet .= "dimensiune=$dimensiune&" if $dimensiune;
$url_remove_judet .= "stadiu=$stadiu&" if $stadiu;
$url_remove_judet .= "sector=$sector&" if $sector;
$url_remove_judet .= "sort=$sort";

my $url_remove_domeniu = "?";
$url_remove_domeniu .= "search=$search&" if $search;
$url_remove_domeniu .= "judet=$judet&" if $judet;
$url_remove_domeniu .= "subdomeniu=$subdomeniu&" if $subdomeniu;
$url_remove_domeniu .= "dimensiune=$dimensiune&" if $dimensiune;
$url_remove_domeniu .= "stadiu=$stadiu&" if $stadiu;
$url_remove_domeniu .= "sector=$sector&" if $sector;
$url_remove_domeniu .= "sort=$sort";

my $url_remove_subdomeniu = "?";
$url_remove_subdomeniu .= "search=$search&" if $search;
$url_remove_subdomeniu .= "judet=$judet&" if $judet;
$url_remove_subdomeniu .= "domeniu=$domeniu&" if $domeniu;
$url_remove_subdomeniu .= "dimensiune=$dimensiune&" if $dimensiune;
$url_remove_subdomeniu .= "stadiu=$stadiu&" if $stadiu;
$url_remove_subdomeniu .= "sector=$sector&" if $sector;
$url_remove_subdomeniu .= "sort=$sort";

my $url_remove_dimensiune = "?";
$url_remove_dimensiune .= "search=$search&" if $search;
$url_remove_dimensiune .= "judet=$judet&" if $judet;
$url_remove_dimensiune .= "domeniu=$domeniu&" if $domeniu;
$url_remove_dimensiune .= "subdomeniu=$subdomeniu&" if $subdomeniu;
$url_remove_dimensiune .= "stadiu=$stadiu&" if $stadiu;
$url_remove_dimensiune .= "sector=$sector&" if $sector;
$url_remove_dimensiune .= "sort=$sort";

my $url_remove_stadiu = "?";
$url_remove_stadiu .= "search=$search&" if $search;
$url_remove_stadiu .= "judet=$judet&" if $judet;
$url_remove_stadiu .= "domeniu=$domeniu&" if $domeniu;
$url_remove_stadiu .= "subdomeniu=$subdomeniu&" if $subdomeniu;
$url_remove_stadiu .= "dimensiune=$dimensiune&" if $dimensiune;
$url_remove_stadiu .= "sector=$sector&" if $sector;
$url_remove_stadiu .= "sort=$sort";

my $url_remove_sector = "?";
$url_remove_sector .= "search=$search&" if $search;
$url_remove_sector .= "judet=$judet&" if $judet;
$url_remove_sector .= "domeniu=$domeniu&" if $domeniu;
$url_remove_sector .= "subdomeniu=$subdomeniu&" if $subdomeniu;
$url_remove_sector .= "dimensiune=$dimensiune&" if $dimensiune;
$url_remove_sector .= "stadiu=$stadiu&" if $stadiu;
$url_remove_sector .= "sort=$sort";
</%init>
<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Santiere - DateSantiere</title>
  <link rel="stylesheet" href="/public/css/styles.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
<% $m->comp('/includes/header.html', user => $user, current => 'projects') %>

<div class="projects-page">
  <div class="container-full">
    <div class="projects-layout">
      <!-- Filters Sidebar -->
      <aside class="filters-sidebar">
        <div class="filters-header">
          <h3>Filtre</h3>
          <button class="filters-reset" onclick="window.location.href='/projects/'">Reseteaza</button>
        </div>

        <form method="get" action="/projects/" class="filters-form">
          <!-- Search -->
          <div class="filter-group">
            <label>Cauta</label>
            <input type="text" name="search" placeholder="Titlu, descriere, solicitari..." value="<% $search %>">
          </div>

          <!-- Judet -->
          <div class="filter-group">
            <label>Judet</label>
            <select name="judet">
              <option value="">Toate judetele</option>
% foreach my $j (@$judete) {
              <option value="<% $j %>" <% $judet eq $j ? 'selected' : '' %>><% $j %></option>
% }
            </select>
          </div>

          <!-- Domeniu -->
          <div class="filter-group">
            <label>Domeniu</label>
            <select name="domeniu">
              <option value="">Toate domeniile</option>
% foreach my $d (@$domenii) {
              <option value="<% $d %>" <% $domeniu eq $d ? 'selected' : '' %>><% $d %></option>
% }
            </select>
          </div>

          <!-- Subdomeniu -->
          <div class="filter-group">
            <label>Subdomeniu</label>
            <select name="subdomeniu">
              <option value="">Toate subdomeniile</option>
% foreach my $sd (@$subdomenii) {
              <option value="<% $sd %>" <% $subdomeniu eq $sd ? 'selected' : '' %>><% $sd %></option>
% }
            </select>
          </div>

          <!-- Dimensiune -->
          <div class="filter-group">
            <label>Dimensiune</label>
            <select name="dimensiune">
              <option value="">Toate dimensiunile</option>
              <option value="Mic" <% $dimensiune eq 'Mic' ? 'selected' : '' %>>Mic</option>
              <option value="Mediu" <% $dimensiune eq 'Mediu' ? 'selected' : '' %>>Mediu</option>
              <option value="Mare" <% $dimensiune eq 'Mare' ? 'selected' : '' %>>Mare</option>
            </select>
          </div>

          <!-- Stadiu -->
          <div class="filter-group">
            <label>Stadiu</label>
            <select name="stadiu">
              <option value="">Toate stadiile</option>
% foreach my $st (@$stadii) {
              <option value="<% $st %>" <% $stadiu eq $st ? 'selected' : '' %>><% $st %></option>
% }
            </select>
          </div>

          <!-- Sector -->
          <div class="filter-group">
            <label>Sector</label>
            <select name="sector">
              <option value="">Toate sectoarele</option>
              <option value="Public" <% $sector eq 'Public' ? 'selected' : '' %>>Public</option>
              <option value="Privat" <% $sector eq 'Privat' ? 'selected' : '' %>>Privat</option>
            </select>
          </div>

          <button type="submit" class="btn-primary btn-block">Aplica filtre</button>
        </form>
      </aside>

      <!-- Results -->
      <div class="projects-content">
        <div class="projects-results-header">
          <div>
            <h2>Lista Santiere</h2>
            <span class="results-count"><% $total_count %> santiere gasite</span>
          </div>
          <div class="sort-dropdown">
            <label>Sorteaza:</label>
            <select id="sortSelect" onchange="applySort(this.value)">
              <option value="created_at_desc" <% $sort eq 'created_at_desc' ? 'selected' : '' %>>Cele mai recente</option>
              <option value="created_at_asc" <% $sort eq 'created_at_asc' ? 'selected' : '' %>>Cele mai vechi</option>
              <option value="valoare_desc" <% $sort eq 'valoare_desc' ? 'selected' : '' %>>Valoare descrescator</option>
              <option value="valoare_asc" <% $sort eq 'valoare_asc' ? 'selected' : '' %>>Valoare crescator</option>
              <option value="titlu_asc" <% $sort eq 'titlu_asc' ? 'selected' : '' %>>Titlu A-Z</option>
              <option value="titlu_desc" <% $sort eq 'titlu_desc' ? 'selected' : '' %>>Titlu Z-A</option>
            </select>
          </div>
        </div>

% if ($search || $judet || $domeniu || $subdomeniu || $dimensiune || $stadiu || $sector) {
        <div class="active-filters">
%   if ($search) {
          <span class="filter-tag">
            Cautare: "<% $search %>"
            <a href="<% $url_remove_search %>" class="filter-remove" title="Sterge filtru">×</a>
          </span>
%   }
%   if ($judet) {
          <span class="filter-tag">
            Judet: <% $judet %>
            <a href="<% $url_remove_judet %>" class="filter-remove" title="Sterge filtru">×</a>
          </span>
%   }
%   if ($domeniu) {
          <span class="filter-tag">
            Domeniu: <% $domeniu %>
            <a href="<% $url_remove_domeniu %>" class="filter-remove" title="Sterge filtru">×</a>
          </span>
%   }
%   if ($subdomeniu) {
          <span class="filter-tag">
            Subdomeniu: <% $subdomeniu %>
            <a href="<% $url_remove_subdomeniu %>" class="filter-remove" title="Sterge filtru">×</a>
          </span>
%   }
%   if ($dimensiune) {
          <span class="filter-tag">
            Dimensiune: <% $dimensiune %>
            <a href="<% $url_remove_dimensiune %>" class="filter-remove" title="Sterge filtru">×</a>
          </span>
%   }
%   if ($stadiu) {
          <span class="filter-tag">
            Stadiu: <% $stadiu %>
            <a href="<% $url_remove_stadiu %>" class="filter-remove" title="Sterge filtru">×</a>
          </span>
%   }
%   if ($sector) {
          <span class="filter-tag">
            Sector: <% $sector %>
            <a href="<% $url_remove_sector %>" class="filter-remove" title="Sterge filtru">×</a>
          </span>
%   }
        </div>
% }

% if (@santiere) {
        <div class="projects-grid">
% foreach my $santier (@santiere) {
          <div class="project-card">
            <div class="project-header">
              <h3><% $santier->{titlu} %></h3>
              <span class="project-id">#<% $santier->{id} %></span>
            </div>
            <div class="project-meta">
              <span class="meta-item"><strong>Judet:</strong> <% $santier->{judet} %></span>
              <span class="meta-item"><strong>Valoare:</strong> <% $santier->{valoare} || 'N/A' %></span>
            </div>
            <div class="project-details">
              <p><strong>Domeniu:</strong> <% $santier->{domeniu} || 'N/A' %> - <% $santier->{subdomeniu} || '' %></p>
              <p><strong>Stadiu:</strong> <% $santier->{stadiu} || 'N/A' %></p>
              <p><strong>Dimensiune:</strong> <% $santier->{dimensiune} %> | <strong>Sector:</strong> <% $santier->{sector} %></p>
            </div>
% if ($santier->{solicitari}) {
            <div class="project-requests">
              <strong>Solicitari:</strong>
              <div class="request-tags">
<%perl>
my @tags = split(/\s*,\s*/, $santier->{solicitari});
foreach my $tag (@tags) {
  $tag =~ s/^\s+|\s+$//g; # trim whitespace
</%perl>
                <span class="request-tag"><% $tag %></span>
<%perl>
}
</%perl>
              </div>
            </div>
% }
            <div class="project-footer">
              <span class="project-date"><% format_date_ro($santier->{created_at}) %></span>
<%perl>
my $judet_upper = uc($santier->{judet} || '');
</%perl>
              <button class="btn-view-details" onclick="openSantierModal(<% $santier->{id} %>, '<% $judet_upper %>')">Vezi detalii</button>
            </div>
          </div>
% }
        </div>
% } else {
        <div class="no-results">
          <h3>Nu am gasit santiere</h3>
          <p>Incerca sa modifici filtrele sau criteriile de cautare</p>
        </div>
% }
      </div>

      <!-- Map Column -->
      <div class="map-column">
        <div id="map" class="projects-map"></div>
      </div>
    </div>
  </div>
</div>

<!-- Santier Modal -->
<div id="santierModal" class="santier-modal">
  <div class="santier-modal-overlay" onclick="closeSantierModal()"></div>
  <div class="santier-modal-dialog">
    <button class="santier-modal-close" onclick="closeSantierModal()">&times;</button>
    <div id="santierModalContent" class="santier-modal-body">
      <div class="loading">Se incarca...</div>
    </div>
  </div>
</div>

<script>
// County coordinates for map centering
const countyCoords = {
  'ALBA': [46.0667, 23.5833],
  'ARAD': [46.1667, 21.3167],
  'ARGES': [44.8667, 24.8667],
  'BACAU': [46.5667, 26.9167],
  'BIHOR': [47.0667, 22.1],
  'BISTRITA-NASAUD': [47.1333, 24.5],
  'BOTOSANI': [47.75, 26.6667],
  'BRASOV': [45.6667, 25.6],
  'BRAILA': [45.2667, 27.9667],
  'BUCURESTI': [44.4268, 26.1025],
  'BUZAU': [45.15, 26.8333],
  'CALARASI': [44.2, 27.3333],
  'CARAS-SEVERIN': [45.3, 22.25],
  'CLUJ': [46.7667, 23.6],
  'CONSTANTA': [44.1667, 28.65],
  'COVASNA': [45.8667, 25.7833],
  'DAMBOVITA': [44.9333, 25.45],
  'DOLJ': [44.3167, 23.8],
  'GALATI': [45.4333, 27.9833],
  'GIURGIU': [43.9, 25.97],
  'GORJ': [45.05, 23.2833],
  'HARGHITA': [46.35, 25.8],
  'HUNEDOARA': [45.75, 22.9],
  'IALOMITA': [44.5667, 27.3667],
  'IASI': [47.1667, 27.6],
  'ILFOV': [44.5667, 26.1333],
  'MARAMURES': [47.6667, 23.5833],
  'MEHEDINTI': [44.6333, 22.6667],
  'MURES': [46.55, 24.5667],
  'NEAMT': [46.9333, 26.3667],
  'OLT': [44.4333, 24.3667],
  'PRAHOVA': [45.1, 26.0167],
  'SALAJ': [47.1833, 23.05],
  'SATU MARE': [47.8, 22.8833],
  'SIBIU': [45.8, 24.15],
  'SUCEAVA': [47.6333, 25.9167],
  'TELEORMAN': [43.9833, 25.3333],
  'TIMIS': [45.75, 21.2333],
  'TULCEA': [45.1667, 28.8],
  'VALCEA': [45.1, 24.3667],
  'VASLUI': [46.6333, 27.7333],
  'VRANCEA': [45.7, 27.1833]
};

function openSantierModal(id, judet) {
  const modal = document.getElementById('santierModal');
  const content = document.getElementById('santierModalContent');
  
  modal.classList.add('active');
  
  content.innerHTML = '<div class="loading">Se incarca...</div>';
  
  fetch('/projects/view_ajax.html?id=' + id)
    .then(response => response.text())
    .then(html => {
      content.innerHTML = html;
    })
    .catch(error => {
      content.innerHTML = '<div class="error">Eroare la incarcarea datelor</div>';
    });
}

function closeSantierModal() {
  const modal = document.getElementById('santierModal');
  modal.classList.remove('active');
}

// Close modal on ESC key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeSantierModal();
  }
});

// Initialize Leaflet map
const map = L.map('map').setView([45.9, 25.0], 6);

// Add OpenStreetMap tile layer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
  maxZoom: 19
}).addTo(map);

// Add markers for santiere
% foreach my $santier (@santiere) {
%   if ($santier->{judet}) {
<%perl>
my $judet_upper = uc($santier->{judet});
</%perl>
(function() {
  const coords = countyCoords['<% $judet_upper %>'];
  if (coords) {
    const marker = L.marker(coords).addTo(map);
    marker.bindPopup(`
      <div style="min-width: 200px;">
        <h4 style="margin: 0 0 8px 0; font-size: 14px;"><% $santier->{titlu} %></h4>
        <p style="margin: 4px 0; font-size: 12px;"><strong>Judet:</strong> <% $santier->{judet} %></p>
        <p style="margin: 4px 0; font-size: 12px;"><strong>Valoare:</strong> <% $santier->{valoare} || 'N/A' %></p>
        <p style="margin: 4px 0; font-size: 12px;"><strong>Domeniu:</strong> <% $santier->{domeniu} || 'N/A' %></p>
        <button onclick="openSantierModal(<% $santier->{id} %>, '<% $judet_upper %>')" style="display: inline-block; margin-top: 8px; padding: 4px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Vezi detalii</button>
      </div>
    `);
  }
})();
%   }
% }

function applySort(sortValue) {
  const url = new URL(window.location.href);
  url.searchParams.set('sort', sortValue);
  window.location.href = url.toString();
}
</script>

<% $m->comp('/includes/footer.html') %>
</body>
</html>

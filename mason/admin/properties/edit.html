<%init>
use lib '/var/www/html/lib';
use AppLib qw(get_user_by_session dbh);
use CGI qw(cookie redirect param);

my $q = CGI->new;
my $session_cookie = $q->cookie('SESSION') || '';
my $user = get_user_by_session($session_cookie);

if (!$user || !$user->{is_admin}) {
  print $q->redirect('/');
  $m->abort();
}

my $property_id = $q->param('id') || '';
my $error = '';
my $success = '';
my $property;

if (!$property_id) {
  $error = 'No property ID provided';
} else {
  my $dbh = dbh();
  
  # Handle form submission
  if ($q->request_method eq 'POST') {
    my $address = $q->param('address') || '';
    my $city = $q->param('city') || '';
    my $state = $q->param('state') || '';
    my $zip_code = $q->param('zip_code') || '';
    my $price = $q->param('price') || '';
    my $bedrooms = $q->param('bedrooms') || '';
    my $bathrooms = $q->param('bathrooms') || '';
    my $square_feet = $q->param('square_feet') || '';
    my $description = $q->param('description') || '';
    
    if ($address eq '' || $city eq '' || $state eq '' || $zip_code eq '') {
      $error = 'Address, city, state, and ZIP code are required';
    } else {
      eval {
        $dbh->do('UPDATE properties SET address = ?, city = ?, state = ?, zip_code = ?, price = ?, bedrooms = ?, bathrooms = ?, square_feet = ?, description = ? WHERE id = ?', 
                 undef, $address, $city, $state, $zip_code, 
                 $price || undef, $bedrooms || undef, $bathrooms || undef, $square_feet || undef, $description, $property_id);
        $success = 'Property updated successfully';
      };
      if ($@) {
        $error = "Update failed: $@";
      }
    }
  }
  
  # Fetch property data (re-fetch after update to show latest values)
  eval {
    my $sth = $dbh->prepare('SELECT * FROM properties WHERE id = ?');
    $sth->execute($property_id);
    $property = $sth->fetchrow_hashref;
  };
  if ($@) {
    $error = "Error loading property: $@";
  } elsif (!$property) {
    $error = 'Property not found';
  }
}
</%init>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Property - Admin</title>
  <link rel="stylesheet" href="/public/css/styles.css">
</head>
<body>
<% $m->comp('/includes/header.html', user => $user, current => 'admin') %>

<div class="admin-page">
  <div class="container">
    <div class="admin-header">
      <h1>Edit Property</h1>
      <a href="/admin/properties/" class="btn-secondary">‚Üê Back to Properties</a>
    </div>

% if ($error) {
    <div class="error"><% $error %></div>
% }

% if ($success) {
    <div class="success"><% $success %></div>
% }

% if ($property) {
    <div class="edit-panel property-edit-panel">
      <form method="post" action="/admin/properties/edit.html?id=<% $property_id %>">
        <input type="hidden" name="id" value="<% $property_id %>">
        
        <div class="form-row-2col">
          <div class="form-group">
            <label>Property ID</label>
            <input type="text" value="<% $property->{id} %>" readonly>
          </div>
          
          <div class="form-group">
            <label>Created At</label>
            <input type="text" value="<% $property->{created_at} %>" readonly>
          </div>
        </div>
        
        <div class="form-group">
          <label for="address">Address *</label>
          <input type="text" id="address" name="address" value="<% $property->{address} %>" required>
        </div>
        
        <div class="form-row-3col">
          <div class="form-group">
            <label for="city">City *</label>
            <input type="text" id="city" name="city" value="<% $property->{city} %>" required>
          </div>
          
          <div class="form-group">
            <label for="state">State *</label>
            <input type="text" id="state" name="state" value="<% $property->{state} %>" required maxlength="50">
          </div>
          
          <div class="form-group">
            <label for="zip_code">ZIP Code *</label>
            <input type="text" id="zip_code" name="zip_code" value="<% $property->{zip_code} %>" required maxlength="20">
          </div>
        </div>
        
        <div class="form-row-3col">
          <div class="form-group">
            <label for="price">Price ($)</label>
            <input type="number" id="price" name="price" value="<% $property->{price} || '' %>" step="0.01" min="0">
          </div>
          
          <div class="form-group">
            <label for="bedrooms">Bedrooms</label>
            <input type="number" id="bedrooms" name="bedrooms" value="<% $property->{bedrooms} || '' %>" min="0">
          </div>
          
          <div class="form-group">
            <label for="bathrooms">Bathrooms</label>
            <input type="number" id="bathrooms" name="bathrooms" value="<% $property->{bathrooms} || '' %>" step="0.5" min="0">
          </div>
        </div>
        
        <div class="form-group">
          <label for="square_feet">Square Feet</label>
          <input type="number" id="square_feet" name="square_feet" value="<% $property->{square_feet} || '' %>" min="0">
        </div>
        
        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" name="description" rows="5"><% $property->{description} || '' %></textarea>
        </div>
        
        <button type="submit" class="btn-primary">Save Changes</button>
      </form>
    </div>
% }
  </div>
</div>

<% $m->comp('/includes/footer.html') %>
</body>
</html>

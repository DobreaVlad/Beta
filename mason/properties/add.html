<%init>
use lib '/var/www/html/lib';
use AppLib qw(get_user_by_session dbh);
use CGI qw(cookie redirect param);

my $q = CGI->new;
my $session_cookie = $q->cookie('SESSION') || '';
my $user = get_user_by_session($session_cookie);

if (!$user) {
  print $q->redirect('/auth/login.html');
  $m->abort();
}

my $error = '';
my $success = '';

if ($q->request_method eq 'POST') {
  my $address = $q->param('address') || '';
  my $city = $q->param('city') || '';
  my $state = $q->param('state') || '';
  my $zip_code = $q->param('zip_code') || '';
  my $price = $q->param('price') || '';
  my $bedrooms = $q->param('bedrooms') || '';
  my $bathrooms = $q->param('bathrooms') || '';
  my $square_feet = $q->param('square_feet') || '';
  my $description = $q->param('description') || '';
  
  if ($address eq '' || $city eq '' || $state eq '' || $zip_code eq '') {
    $error = 'Address, city, state, and ZIP code are required';
  } else {
    my $dbh = dbh();
    eval {
      $dbh->do('INSERT INTO properties (address, city, state, zip_code, price, bedrooms, bathrooms, square_feet, description) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)', 
               undef, $address, $city, $state, $zip_code, 
               $price || undef, $bedrooms || undef, $bathrooms || undef, $square_feet || undef, $description);
      $success = 'Property added successfully!';
    };
    if ($@) {
      $error = "Failed to add property: $@";
    }
  }
}
</%init>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Property - PropertySite</title>
  <link rel="stylesheet" href="/public/css/styles.css">
</head>
<body>
<% $m->comp('/includes/header.html', user => $user, current => 'properties') %>

<div class="admin-page">
  <div class="container">
    <div class="admin-header">
      <h1>Add New Property</h1>
      <a href="/properties/" class="btn-secondary">‚Üê Back to Properties</a>
    </div>

% if ($error) {
    <div class="error"><% $error %></div>
% }

% if ($success) {
    <div class="success"><% $success %></div>
% }

    <div class="edit-panel property-edit-panel">
      <form method="post" action="/properties/add.html">
        <div class="form-group">
          <label for="address">Address *</label>
          <input type="text" id="address" name="address" placeholder="123 Main Street" required>
        </div>
        
        <div class="form-row-3col">
          <div class="form-group">
            <label for="city">City *</label>
            <input type="text" id="city" name="city" placeholder="San Francisco" required>
          </div>
          
          <div class="form-group">
            <label for="state">State *</label>
            <input type="text" id="state" name="state" placeholder="CA" required maxlength="50">
          </div>
          
          <div class="form-group">
            <label for="zip_code">ZIP Code *</label>
            <input type="text" id="zip_code" name="zip_code" placeholder="94102" required maxlength="20">
          </div>
        </div>
        
        <div class="form-row-3col">
          <div class="form-group">
            <label for="price">Price ($)</label>
            <input type="number" id="price" name="price" placeholder="1250000" step="0.01" min="0">
          </div>
          
          <div class="form-group">
            <label for="bedrooms">Bedrooms</label>
            <input type="number" id="bedrooms" name="bedrooms" placeholder="3" min="0">
          </div>
          
          <div class="form-group">
            <label for="bathrooms">Bathrooms</label>
            <input type="number" id="bathrooms" name="bathrooms" placeholder="2" step="0.5" min="0">
          </div>
        </div>
        
        <div class="form-group">
          <label for="square_feet">Square Feet</label>
          <input type="number" id="square_feet" name="square_feet" placeholder="1800" min="0">
        </div>
        
        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" name="description" rows="5" placeholder="Describe the property..."></textarea>
        </div>
        
        <button type="submit" class="btn-primary">Add Property</button>
      </form>
    </div>
  </div>
</div>

<% $m->comp('/includes/footer.html') %>
</body>
</html>
